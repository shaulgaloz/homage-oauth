<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miko3 OAuth Callback</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f5f5f5;
            margin: 0;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .success { color: #4CAF50; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .instruction { 
            background: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        .code-display {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .step {
            background: #fff3e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
            text-align: left;
        }
        .redirect-button {
            background-color: #4CAF50;
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            margin: 15px;
            font-weight: bold;
        }
        .close-button {
            background-color: #ff9800;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
        }
        .persistent-note {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ü§ñ Miko3 Authentication</h2>
        <div id="status">Processing authentication...</div>
        
        <div id="success-section" style="display: none;">
            <div class="instruction">
                <span class="success">‚úÖ Authentication Successful!</span><br>
                Your Miko3 robot now has access to Google Calendar & Tasks
            </div>
            
            <div class="step">
                <strong>üì± STEP 1:</strong> Click this button to return to your robot:
                <br><br>
                <button id="redirect-button" class="redirect-button">ü§ñ Return to Miko3 Robot</button>
            </div>
            
            <div class="step">
                <strong>üîß STEP 2 (If button doesn't work):</strong><br>
                1. <strong>Keep this page open</strong> - don't close the browser yet!<br>
                2. Go back to your Miko3 robot<br>
                3. The authentication should complete automatically<br>
                4. Then you can close this browser
            </div>
            
            <div class="persistent-note">
                <strong>‚ö†Ô∏è Important:</strong> This page will stay open for 10 minutes to ensure your robot receives the authentication. You can close it after your robot confirms successful authentication.
            </div>
            
            <div id="attempts-log" style="margin-top: 20px; font-size: 12px; color: #666;"></div>
            
            <button id="close-browser" class="close-button">Close Browser (only after robot confirms)</button>
        </div>
        
        <div id="error-section" style="display: none;">
            <div class="instruction">
                <span class="error">‚ùå Authentication Failed</span><br>
                <div id="error-details"></div>
            </div>
            <button id="close-browser-error" class="close-button">Close Browser & Try Again</button>
        </div>
    </div>

    <script>
        console.log('OAuth callback page loaded');
        console.log('Current URL:', window.location.href);
        
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        const error = urlParams.get('error');
        
        let attemptCount = 0;
        let maxAttempts = 20; // Try for 10 minutes (every 30 seconds)
        
        function logAttempt(message) {
            const log = document.getElementById('attempts-log');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `${timestamp}: ${message}<br>`;
            console.log(message);
        }
        
        function redirectToApp(appUrl, isAutomatic = false) {
            attemptCount++;
            const attemptType = isAutomatic ? 'Automatic' : 'Manual';
            logAttempt(`${attemptType} redirect attempt #${attemptCount}`);
            
            console.log('Redirecting to app:', appUrl);
            
            // Create multiple redirect attempts
            window.location.href = appUrl;
            
            // Backup methods
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = appUrl;
                link.click();
                logAttempt('Backup link click method attempted');
            }, 500);
            
            // Schedule next automatic attempt if this was automatic and we haven't exceeded max attempts
            if (isAutomatic && attemptCount < maxAttempts) {
                setTimeout(() => {
                    logAttempt(`Scheduling next automatic attempt in 30 seconds...`);
                    setTimeout(() => redirectToApp(appUrl, true), 30000);
                }, 1000);
            }
        }
        
        function attemptBrowserClose() {
            console.log('Attempting to close browser...');
            logAttempt('User requested browser close');
            
            try {
                window.close();
                if (window.parent && window.parent !== window) {
                    window.parent.close();
                }
                
                setTimeout(() => window.location.href = 'about:blank', 1000);
                setTimeout(() => window.location.href = 'via://close', 1500);
                
            } catch (e) {
                console.log('Browser close failed:', e);
                logAttempt('Browser close failed: ' + e.message);
            }
        }
        
        if (authCode) {
            console.log('Auth code received:', authCode.substring(0, 10) + '...');
            logAttempt('OAuth authorization code received successfully');
            
            // Show success section
            document.getElementById('success-section').style.display = 'block';
            document.getElementById('status').style.display = 'none';
            
            const appUrl = `com.homagerobotics.miko3homage://oauth?code=${encodeURIComponent(authCode)}`;
            
            // Manual redirect button
            document.getElementById('redirect-button').onclick = function() {
                console.log('Manual redirect clicked');
                redirectToApp(appUrl, false);
            };
            
            // Manual close button
            document.getElementById('close-browser').onclick = function() {
                console.log('Manual close clicked');
                attemptBrowserClose();
            };
            
            // Start automatic attempts after 5 seconds, then every 30 seconds
            setTimeout(() => {
                logAttempt('Starting automatic redirect attempts...');
                redirectToApp(appUrl, true);
            }, 5000);
            
        } else if (error) {
            console.log('OAuth error:', error);
            
            document.getElementById('error-section').style.display = 'block';
            document.getElementById('status').style.display = 'none';
            document.getElementById('error-details').textContent = error;
            
            document.getElementById('close-browser-error').onclick = function() {
                attemptBrowserClose();
            };
            
        } else {
            console.log('No auth code or error');
            document.getElementById('status').innerHTML = '‚ö†Ô∏è <span class="error">No authentication data received</span>';
            setTimeout(attemptBrowserClose, 3000);
        }
    </script>
</body>
</html>
